<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alerta Bet BR • Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0e1117;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --text: #e8eef8;
      --muted:#9fb2c7;
      --accent:#78c1ff;
      --ok:#41d39a;
      --warn:#ffd166;
      --bad:#ff6b6b;
      --glass-blur: 10px;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing: border-box; }
    html, body{
      margin:0; padding:0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    .container{
      max-width: 1100px; margin: 28px auto; padding: 0 18px;
    }

    header{
      display:flex; align-items: center; justify-content: space-between;
      gap: 16px; margin-bottom: 18px;
    }
    .brand{ font-weight: 800; letter-spacing: .3px; }
    .brand b{ color: var(--accent); }
    .status-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px; }
    .dot-ok{ background: var(--ok); box-shadow: 0 0 16px var(--ok); }
    .dot-bad{ background: var(--bad); box-shadow: 0 0 16px var(--bad); }
    .dot-warn{ background: var(--warn); box-shadow: 0 0 16px var(--warn); }

    .card{
      background: var(--panel);
      border: 1px solid var(--panel-strong);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--glass-blur));
    }

    .grid{
      display:grid; gap: 18px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
    }

    .kpis{
      grid-column: 1 / -1;
      display:grid; gap: 14px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    .kpi{
      padding: 16px 18px;
    }
    .kpi .label{ font-size: 12px; color: var(--muted); letter-spacing:.4px; }
    .kpi .value{ font-size: 28px; font-weight: 800; margin-top: 6px; }

    .big{
      grid-column: span 8;
      padding: 18px;
      min-height: 420px;
      display:flex; flex-direction: column;
    }
    .side{
      grid-column: span 4;
      display:flex; flex-direction: column; gap: 18px;
    }

    .panel-title{
      font-weight: 700; color: var(--muted); letter-spacing: .4px; margin-bottom: 8px;
    }

    .events{
      padding: 18px; max-height: 360px; overflow: auto;
    }
    .event{
      display:flex; justify-content: space-between; align-items: center;
      gap:10px; padding: 10px 12px; border-radius: var(--radius-sm);
      background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.07);
      margin-bottom: 10px;
    }
    .event .type{ font-weight: 700; }
    .pill{ padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .pill-ok{ background: rgba(65,211,154,.18); color: var(--ok); border:1px solid rgba(65,211,154,.35); }
    .pill-bad{ background: rgba(255,107,107,.18); color: var(--bad); border:1px solid rgba(255,107,107,.35); }
    .pill-info{ background: rgba(120,193,255,.18); color: var(--accent); border:1px solid rgba(120,193,255,.35); }

    .risk-banner{
      display:none;
      margin-top: 14px;
      padding: 16px 18px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,107,107,.85), rgba(255,90,90,.72));
      border: 1px solid rgba(255,107,107,.6);
      box-shadow: var(--shadow);
      animation: pulse 1.6s ease-in-out infinite;
    }
    .risk-banner.show{ display:block; }
    .risk-banner h3{ margin: 0 0 6px 0; font-size: 22px; }
    .risk-banner p{ margin:0; color: #fff; opacity:.9; }

    @keyframes pulse{
      0%{ transform: scale(1); }
      50%{ transform: scale(1.01); }
      100%{ transform: scale(1); }
    }

    .actions{ display:flex; align-items:center; gap: 10px; }
    button{
      background: rgba(120,193,255,.1);
      border:1px solid rgba(120,193,255,.35);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
    }
    button:hover{ background: rgba(120,193,255,.16); }
    .btn-danger{
      background: rgba(255,107,107,.12);
      border:1px solid rgba(255,107,107,.45);
    }
    .btn-danger:hover{ background: rgba(255,107,107,.18); }

    .footer{
      text-align:center; color: var(--muted); font-size: 12px;
      margin: 22px 0 40px;
    }

    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .big{ grid-column: 1 / -1; }
      .side{ grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="brand" style="font-size:22px;">Alerta <b>Bet BR</b> • Dashboard</div>
        <div style="margin-top:6px; color:var(--muted); font-size:13px;">
          <span id="api-dot" class="status-dot dot-warn"></span>
          <span id="api-state">Conectando à API…</span>
        </div>
      </div>
      <div class="actions">
        <button id="btn-reset" class="btn-danger" title="POST /reset">Resetar contadores</button>
        <a href="http://127.0.0.1:8000/docs" target="_blank" style="text-decoration:none;">
          <button>API Docs</button>
        </a>
      </div>
    </header>

    <!-- KPIs -->
    <section class="kpis">
      <div class="card kpi">
        <div class="label">Status</div>
        <div class="value"><span id="lbl-risk">—</span></div>
      </div>
      <div class="card kpi">
        <div class="label">Tempo ativo (min)</div>
        <div class="value" id="lbl-mins">0.0</div>
      </div>
      <div class="card kpi">
        <div class="label">Blinks / min</div>
        <div class="value" id="lbl-blink">0.0</div>
      </div>
      <div class="card kpi">
        <div class="label">Faces detectadas</div>
        <div class="value" id="lbl-faces">0</div>
      </div>
    </section>

    <div class="grid" style="margin-top:18px;">
      <!-- chart -->
      <section class="card big">
        <div class="panel-title">Alertas de risco (últimas 24h)</div>
        <canvas id="alertsChart" style="width:100%;height:100%;min-height:320px;"></canvas>
        <div id="risk-banner" class="risk-banner">
          <h3>⚠️ RISCO — PAUSA AGORA</h3>
          <p>Faça uma pausa. Pressione <b>R</b> na aplicação para resetar os contadores.</p>
        </div>
      </section>

      <!-- eventos -->
      <aside class="side">
        <div class="card events">
          <div class="panel-title">Eventos recentes</div>
          <div id="events"></div>
        </div>

        <div class="card" style="padding:16px 18px;">
          <div class="panel-title">Dicas rápidas</div>
          <ul style="margin:8px 0 0 18px; color:var(--muted); line-height:1.55;">
            <li>Ajuste “risk_min” na janela de controles (app) para testes rápidos (ex.: 1 min).</li>
            <li>Iluminação frontal melhora a estabilidade da detecção.</li>
            <li>Você pode resetar por aqui (POST /reset) ou teclando <b>R</b> no app.</li>
          </ul>
        </div>
      </aside>
    </div>

    <div class="footer">Alerta Bet BR • Integração API + Dashboard • © 2025</div>
  </div>

  <script>
  const API = "http://127.0.0.1:8000";

  // --------------- helpers ---------------
  const fmt2 = (n)=>String(n).padStart(2,"0");
  const $ = (id)=>document.getElementById(id);

  function isoToLocalHM(d) {
    const dt = (d instanceof Date) ? d : new Date(d);
    return `${fmt2(dt.getHours())}:${fmt2(dt.getMinutes())}`;
  }
  function setApiState(ok){
    const dot = $("api-dot"), st  = $("api-state");
    if(ok){ dot.className="status-dot dot-ok"; st.textContent = "API conectada"; }
    else  { dot.className="status-dot dot-bad"; st.textContent = "API indisponível"; }
  }

  // Converte qualquer formato de timestamp
  function normalizeDate(ev) {
    let t = ev?.timestamp ?? ev?.time ?? ev?.ts ?? ev?.datetime ?? ev?.date;
    if (t == null) return null;
    // epoch numérico
    if (typeof t === "number") {
      // heurística: se for em segundos
      if (t < 1e12) return new Date(t * 1000);
      return new Date(t);
    }
    // string ISO
    const dt = new Date(t);
    return isNaN(+dt) ? null : dt;
  }

  // --------------- gráfico 24h ---------------
  const labels24 = [];
  (function makeLabels(){
    const now = new Date();
    for(let i=23;i>=0;i--){
      const d = new Date(now.getTime() - i*3600*1000);
      labels24.push(`${fmt2(d.getHours())}h`);
    }
  })();

  const ctx = document.getElementById("alertsChart");
  const alertsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels24,
      datasets: [{
        label: 'Alertas (risk)',
        data: new Array(24).fill(0),
        borderRadius: 8,
        backgroundColor: 'rgba(255,107,107,.65)',
        borderColor: 'rgba(255,107,107,1)',
        borderWidth: 1.5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#e8eef8' } },
        tooltip: {
          callbacks:{
            title: (i)=> `Hora: ${i[0].label}`,
            label: (i)=> `Alertas: ${i.formattedValue}`
          }
        }
      },
      scales: {
        x: { ticks: { color: '#9fb2c7' }, grid: { color: 'rgba(255,255,255,.08)' } },
        y: { ticks: { color: '#9fb2c7' }, grid: { color: 'rgba(255,255,255,.08)' }, beginAtZero:true, suggestedMax: 5 }
      }
    }
  });

  function build24hSeries(events){
    const now = new Date();
    const buckets = new Array(24).fill(0);

    for(const ev of events || []){
      const type = (ev?.type || "").toString().toLowerCase();
      if(type !== "risk") continue;

      const dt = normalizeDate(ev);
      if(!dt) continue;

      const diffH = Math.floor((now - dt) / 3600000); // horas atrás
      if(diffH >= 0 && diffH < 24){
        const idx = 23 - diffH; // 0=23h atrás ... 23=agora
        buckets[idx] += 1;
      }
    }
    return buckets;
  }

  // --------------- status + eventos ---------------
  let prevRisky = null;          // para fallback de eventos locais
  const localEvents = [];        // guardamos "risk" detectado via /status (fallback)

  async function getStatus(){
    try{
      const r = await fetch(`${API}/status`, {cache:'no-store'});
      if(!r.ok) throw new Error();
      const s = await r.json();
      setApiState(true);
      updateKpis(s);
      updateBanner(s);

      // Fallback: criar evento local quando entra em risco
      if (s && typeof s.risky === "boolean") {
        if (prevRisky === false && s.risky === true) {
          localEvents.push({ type: "risk", timestamp: new Date().toISOString(), msg: "frontend-fallback" });
        }
        prevRisky = s.risky;
      }
    }catch(e){
      setApiState(false);
    }
  }

  function updateKpis(s){
    const risk = s.risky ? "RISCO" : "OK";
    $("lbl-risk").innerHTML = s.risky ? `<span class="pill pill-bad">${risk}</span>` : `<span class="pill pill-ok">${risk}</span>`;
    $("lbl-mins").textContent  = (s.minutes_on ?? 0).toFixed(1);
    $("lbl-blink").textContent = (s.blink_rate ?? 0).toFixed(1);
    $("lbl-faces").textContent = (s.faces ?? 0);
  }

  function updateBanner(s){
    const b = $("risk-banner");
    if(s.risky) b.classList.add("show"); else b.classList.remove("show");
  }

  async function getEvents(){
    try{
      const r = await fetch(`${API}/events`, {cache:'no-store'});
      if(!r.ok) throw new Error();
      let list = await r.json();
      // aceita {events:[...]} | {data:[...]} | [...]
      if (Array.isArray(list) === false) {
        list = list?.events || list?.data || list?.items || [];
      }
      // junta com eventos locais (sem duplicar demais)
      const merged = [...list, ...localEvents].slice(-500);

      renderEvents(merged);
      const series = build24hSeries(merged);
      alertsChart.data.datasets[0].data = series;
      alertsChart.update();
    }catch(e){
      // Se /events falhar, usa só os locais (fallback)
      const merged = [...localEvents].slice(-500);
      renderEvents(merged);
      const series = build24hSeries(merged);
      alertsChart.data.datasets[0].data = series;
      alertsChart.update();
    }
  }

  function renderEvents(list){
    const box = $("events");
    box.innerHTML = "";
    (list || []).slice(-30).reverse().forEach(ev=>{
      const wrap = document.createElement("div");
      wrap.className = "event";
      const pill = ev.type === 'risk' ? 'pill-bad' : (ev.type === 'reset' ? 'pill-info' : 'pill-ok');

      const when = normalizeDate(ev) || new Date();
      const msg  = ev.msg || "";

      wrap.innerHTML = `
        <div>
          <div class="type">${(ev.type || "EVENTO").toUpperCase()}</div>
          <div style="color:var(--muted); font-size:13px;">${msg}</div>
        </div>
        <div>
          <span class="pill ${pill}">${isoToLocalHM(when)}</span>
        </div>
      `;
      box.appendChild(wrap);
    });
    if(!box.children.length){
      box.innerHTML = `<div style="color:var(--muted);">Sem eventos ainda…</div>`;
    }
  }

  // --------------- ações ---------------
  $("btn-reset").addEventListener("click", async ()=>{
    try{
      await fetch(`${API}/reset`, { method:"POST" });
      await getEvents();
      await getStatus();
    }catch(e){}
  });

  // --------------- loop ---------------
  getStatus(); getEvents();
  setInterval(getStatus, 1000);   // status 1s
  setInterval(getEvents, 3000);   // eventos 3s (mais responsivo para a demo)
</script>
